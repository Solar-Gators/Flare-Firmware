TODO:
add clang tidy
make sams bms project
make nates bms project
put videos that explain workflow, as well as creating project in cubemx and also porting them to cubeide

# Solar Gators Flare Firmware

- **CMake** + **Ninja** build system
- Shared **resources** (HAL, CMSIS, FreeRTOS, toolchains, Drivers)
- **pre-commit** hook enforcing **clang-format**
- **Unified** intellisense for all firmware subfolders using root cmakelists.txt

---

## üöÄ Quick Start (Windows) (Can be done on linux type OS too using whatever package manager you have and regular terminal)

1. **Clone this repo**
    ```sh
    git clone https://github.com/Solar-Gators/Flare-Firmware.git
    cd Flare-Firmware
    ```

2. **Install MSYS2**  
   Download: https://www.msys2.org/  
   Open an `MSYS2 Mingw64` terminal (Start menu).
   All the following commands need to be ran in an MSYS2 Mingw64 (Unix like) terminal

3. **Install build tools**
    ```sh
    pacman -Syu         # Update system, restart if prompted
    pacman -S --needed \
      mingw-w64-x86_64-python-pre-commit \
      make \
      ninja \
      cmake \
      git \
      python-pip \
      clang
    ```

4. **Install Python deps**
    ```sh
    pip install --upgrade pip
    pip install pre-commit
    ```

5. **Install pre-commit hook**
    ```sh
    pre-commit install
    ```

6. **Build/Work on a firmware project**
    ```sh
    git checkout -b your-development-branch # Do work on your own dev branch, name it with ur name or feature ur adding
    cd firmware/CAN-DevBoard # cd into the specific project you wanna work on
    make              # Debug build (default)
    make clean        # Clean build folder
    make BUILD_TYPE=Release  # Release build
    ```
    
7. **Import project into CubeIDE so that it can easily be built and debugged**
    - Open STM32CubeIDE ‚Üí File ‚Üí New ‚Üí Makefile project with existing code
    - Project Directory: select firmware/YourProject
    - Project Name: should autofill but it would be YourProject
    - Toolchain: choose MCU ARM GCC
    - Languages: Both C and C++ (Should auto fill)
    - CubeIDE will index the project and should build immediately using your Makefile/Ninja/CMake setup (via Project ‚Üí Build or the hammer icon).

8. **Run and Debug project**
    - Create a Debug Configuration by clicking drop down next to debug button of type STM32 C/C++ Application (Set the ELF path to build/YourProject.elf).
    - You can select the correct one when going to run by adding them to favorites and selecting them with the drop down.
    - Flash and start a debug or flash session.

## Other Notes

- **From firmware subfolder** (`cd firmware/project1`):

    ```sh
    make                 # Build debug
    make clean           # Remove build
    make BUILD_TYPE=Release   # Build release
    ```
---

- **After modifying ioc file**
    You may need to do `make clean` in the terminal before rebuilding.

---

- **Clang-Format**:  
    Every `git commit`, clang-format is auto-applied to C/C++ files (`.c`, `.cpp`, `.h`, `.hpp`).  
    If changes are made, the commit is **blocked** and you must re-add the formatted files.

    ```
    git add .
    git commit -m "Some message"
    # If "files were modified by this hook", re-add and commit again.
    ```

- **Format all files manually**:
    ```sh
    pre-commit run --all-files
    ```

- **Style config**:  
    See `.clang-format` in the repo root

---

### Individual Project Structure (a project inside of the firmware folder)
```sh
project-folder/
‚îú‚îÄ‚îÄ build/             # Output folder for build artifacts (e.g., .elf, .hex, .bin files). Does not get pushed to repo
‚îú‚îÄ‚îÄ Core/              # Main application source code (auto-generated by STM32CubeMX). int main() lives in here, try to write limited code in this folder.
‚îú‚îÄ‚îÄ CubeMX/            # CubeMX configuration files. Folder can basically be ignored and is just for some build stuff
‚îú‚îÄ‚îÄ user/              # User-defined source code. Most of our code should live within this folder. 
‚îú‚îÄ‚îÄ .mxproject         # STM32CubeMX project configuration file
‚îú‚îÄ‚îÄ CMakeLists.txt     # CMake build script for project compilation
‚îú‚îÄ‚îÄ Makefile           # Makefile for building project easily (calls cmake).
‚îî‚îÄ‚îÄ project1.ioc       # STM32CubeMX configuration file describing MCU setup
```
---

### üß† VS Code + IntelliSense:
- Open root of repo or open specific subproject
- Point vscode/cmaketools extension to cmakelists.txt in root of whatever you opened

---

### Creating a New Project Steps:
- Open CubeMX, and configure your MCU/board/peripherals as usual.
- Project Manager (before code generation)
- Project Location: set to your repo‚Äôs firmware/ folder.
- Toolchain/IDE: select Makefile (We‚Äôll use our own build system; this prevents IDE-specific files.)
- Toolchain Folder Location: add another /CubeMX to the path that is in the box already (This makes CubeMX put startup files/linker script and toolchain bits under firmware/<Project>/CubeMX/.) 
- Generate code
- CubeMX creates Core/, drivers, and the CubeMX/ subfolder inside firmware/<YourProject>/.
- Copy your template Makefile and CMakeLists.txt from another project (use CAN-DevBoard project) into firmware/<YourProject>/.
- Edit the top portion of the CMakeLists.txt with information specific to your project's mcu.
- You should now be able to type `make` in the terminal to build the project.
- You can also add a user/ folder with inc/ and src/ inside of it, to separate our code from the generated code in Core/

---

## üñ•Ô∏è Recommended VS Code Settings

There is a way to add the MSYS2 Mingw64 terminal in vscode so you don't have to switch windows to use the terminal.
